<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Hedge — Starter UI</title>
  <style>
    :root { color-scheme: light dark;
      --bg0:#0b0f17; --bg1:#101726; --card:rgba(255,255,255,0.04); --border:rgba(255,255,255,0.12);
      --fg:#e7e9ee; --muted:#9aa0a6; --green:#18c37d; --red:#ff5a6e; --primary:#7f5af0;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:
        radial-gradient(1200px 600px at 0% 0%, rgba(127,90,240,.12), transparent 60%),
        radial-gradient(1000px 500px at 100% 0%, rgba(44,182,125,.12), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    header{
      position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;backdrop-filter:blur(10px);background:rgba(8,12,18,.55);border-bottom:1px solid var(--border)
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo-dot{width:10px;height:10px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#2cb67d,#7f5af0);box-shadow:0 0 14px rgba(127,90,240,.6)}
    .title{margin:0;font-size:16px;letter-spacing:.2px}
    .header-right{display:flex;gap:10px;align-items:center}
    .env-badge{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--muted)}
    .env-live{color:#ffd166;border-color:rgba(255,209,102,.35)}
    .env-local{color:#7bdcff;border-color:rgba(123,220,255,.35)}
    .btn{background:var(--card);color:var(--fg);border:1px solid var(--border);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;transition:transform .04s,filter .15s}
    .btn:hover{filter:brightness(1.1)} .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(127,90,240,.45);box-shadow:inset 0 0 0 1px rgba(127,90,240,.25)}
    .btn.danger{border-color:rgba(255,90,110,.35)}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;border:1px solid var(--border);background:var(--card)}
    .pill .pdot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .pill.ok{color:var(--green);border-color:rgba(24,195,125,.35)} .pill.ok .pdot{background:var(--green)}
    .pill.down{color:var(--red);border-color:rgba(255,90,110,.35)} .pill.down .pdot{background:var(--red)}
    .page{max-width:1200px;margin:14px auto;padding:0 16px 24px}
    .grid{display:grid;grid-template-columns:0.35fr 0.65fr;gap:24px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--border);border-radius:16px;background:var(--card);box-shadow:0 10px 25px rgba(0,0,0,.25);overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .card-b{padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="date"],input[type="number"]{width:100%;max-width:260px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    .status{font-size:12px;color:var(--muted)} .status.ok{color:var(--green)} .status.err{color:var(--red)}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--muted);border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    pre{margin:0;white-space:pre-wrap;word-wrap:break-word;max-height:420px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:12px;padding:12px}
    footer{color:var(--muted);text-align:center;padding:12px;border-top:1px solid var(--border)}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
    .chev{transition:transform .2s ease} .rot{transform:rotate(90deg)}
    .collapse{height:0;overflow:hidden;transition:height .22s ease}
    .qc-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* chart */
    .chart-wrap{margin-top:14px;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.25);padding:8px}
    #eqCanvas{width:100%;height:260px;display:block}
    .legend{display:flex;gap:12px;font-size:12px;color:var(--muted);margin:6px 4px 0}
    .key{display:inline-flex;align-items:center;gap:6px}
    .swatch{width:10px;height:10px;border-radius:2px;background:#8ab4f8}
    .swatch.bench{background:#fbbc04}
    .legend small{opacity:.9}
    .chart-note{font-size:12px;color:var(--muted);margin:6px 4px 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="logo-dot"></span>
      <h1 class="title">AI Hedge — Starter UI</h1>
    </div>
    <div class="header-right">
      <span id="envBadge" class="env-badge">ENV</span>
    </div>
  </header>

  <main class="page">
    <section class="grid">
      <!-- Left: Quick Check -->
      <div class="card" id="qcCard">
        <div class="card-h" id="qcHeader" style="cursor:pointer">
          <span>Quick Check</span>
          <div class="qc-actions" aria-hidden="true">
            <span id="healthPill" class="pill"><span class="pdot"></span><span class="plabel">—</span></span>
            <button id="btnHealth" class="btn">Health</button>
            <span class="chev" id="qcChev">▶</span>
          </div>
        </div>
        <div class="card-b collapse" id="qcBody">
          <div class="row" style="margin-bottom:10px">
            <button id="btnPing" class="btn primary">Call <code>/</code></button>
            <button id="btnClearPing" class="btn danger">Clear</button>
            <span id="status" class="status"></span>
          </div>
          <pre id="out">(click the button)</pre>
        </div>
      </div>

      <!-- Right: Controls + Equity Chart -->
      <div class="card">
        <div class="card-h">Hedge-Fund Controls</div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="tickers">Tickers</label>
              <input id="tickers" type="text" placeholder="e.g. AAPL, MSFT"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="start">Start date</label>
              <input id="start" type="date"/>
            </div>
            <div>
              <label for="end">End date</label>
              <input id="end" type="date"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="cash">Initial cash ($)</label>
              <input id="cash" type="number" value="100000"/>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="btnRun" class="btn primary">Run</button>
            <button id="btnBacktest" class="btn">Backtest</button>
            <button id="btnCSV" class="btn">Download CSV</button>
            <button id="btnPNG" class="btn">Download PNG</button>
            <button id="btnClear" class="btn danger">Clear</button>
            <span id="hfStatus" class="status"></span>
          </div>

          <h4 style="margin:14px 0 6px">Result</h4>
          <pre id="hfOut" style="max-height:220px; overflow:auto">(results will appear here)</pre>

          <div class="chart-wrap">
            <canvas id="eqCanvas"></canvas>
            <div class="legend">
              <span class="key"><span class="swatch"></span> Strategy</span>
              <span class="key"><span class="swatch bench"></span> Benchmark</span>
            </div>
            <div id="chartNote" class="chart-note"></div>
          </div>

          <div style="margin-top:8px; color:var(--muted); font-size:12px;">
            Shortcuts: <small class="kbd">Enter</small> = Run, <small class="kbd">Shift+Enter</small> = Backtest.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>Open <code>/docs</code> for interactive API docs.</footer>

  <script>
    const $ = id => document.getElementById(id);

    // --- Environment badge ---
    (function envTag(){
      const live = location.hostname.includes("onrender.com");
      const el = $("envBadge");
      el.textContent = live ? "LIVE" : "LOCAL";
      el.classList.add(live ? "env-live" : "env-local");
      el.title = location.origin;
    })();

    // --- Health Pill ---
    const pill = $("healthPill"), pillLabel = pill.querySelector(".plabel");
    function setPill(state){
      pill.classList.remove("ok","down");
      if(state===true){ pill.classList.add("ok"); pillLabel.textContent="OK"; }
      else if(state===false){ pill.classList.add("down"); pillLabel.textContent="Down"; }
      else { pillLabel.textContent="—"; }
    }
    async function checkHealth(showOut=false){
      try{ const r=await fetch("/health"); const j=await r.json();
        setPill(!!j.ok); if(showOut) $("out").textContent = JSON.stringify(j,null,2);
      }catch{ setPill(false); if(showOut) $("out").textContent="Health check failed."; }
    }
    $("btnHealth").addEventListener("click",()=>checkHealth(true));
    setInterval(checkHealth,60_000);

    // --- Quick Check collapsible ---
    const qcHeader=$("qcHeader"), qcBody=$("qcBody"), qcChev=$("qcChev");
    function setQCCollapsed(collapsed){
      sessionStorage.setItem("qcCollapsed", collapsed ? "1" : "0");
      if(collapsed){ qcChev.classList.remove("rot"); qcBody.style.height="0px"; }
      else { qcChev.classList.add("rot"); qcBody.style.height = qcBody.scrollHeight + "px"; }
    }
    qcHeader.addEventListener("click", ()=>{
      const collapsed = sessionStorage.getItem("qcCollapsed") !== "1" ? false : true;
      setQCCollapsed(!collapsed);
    });

    // --- Helpers ---
    const hfStatus=$("hfStatus"), hfOut=$("hfOut"), chartNote=$("chartNote");
    const setHF=(m,c="")=>{hfStatus.className="status "+c;hfStatus.innerHTML=m};
    const hfLoading=()=>setHF('<span class="spinner"></span> Working…');
    const hfOk=m=>setHF(m,"ok"); const hfErr=m=>setHF(m,"err");
    const postJSON=async(path,body)=>{
      const res=await fetch(path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.json();
    };
    const getTickers=()=>($("tickers").value||"").split(",").map(s=>s.trim()).filter(Boolean);

    // --- Equity Chart (Canvas, responsive) ---
    const canvas = $("eqCanvas");
    let ctx = canvas.getContext("2d");
    let curve = null; // {dates, strat, bench}

    function sizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(600, Math.floor(rect.width * dpr));
      canvas.height = Math.max(220, Math.floor(rect.height * dpr));
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawChart();
    }

    function drawChart() {
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // bg
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // if no data
      if (!curve || (!curve.strat?.length && !curve.bench?.length)) {
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted");
        ctx.font = "12px ui-sans-serif, system-ui";
        ctx.fillText("No equity curve to display yet.", 12, 20);
        return;
      }

      // margins
      const pad = {l:48, r:12, t:14, b:24};
      const W = canvas.clientWidth, H = canvas.clientHeight;
      const x0 = pad.l, y0 = pad.t, x1 = W - pad.r, y1 = H - pad.b;

      // x domain
      const n = Math.max(curve.strat?.length || 0, curve.bench?.length || 0);
      const x = i => x0 + (i/(Math.max(1,n-1)))*(x1-x0);

      // y domain from both series
      const all = [
        ...(curve.strat||[]),
        ...(curve.bench||[])
      ].filter(v => Number.isFinite(v));
      const ymin = Math.min(...all), ymax = Math.max(...all);
      const y = v => y1 - ((v - ymin) / (ymax - ymin || 1)) * (y1 - y0);

      // axes
      ctx.strokeStyle = "rgba(255,255,255,0.15)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x0, y0); ctx.lineTo(x0, y1); ctx.lineTo(x1, y1);
      ctx.stroke();

      // gridlines (4)
      ctx.font = "11px ui-sans-serif, system-ui";
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted");
      for (let k=0;k<=4;k++){
        const yy = y0 + k*(y1-y0)/4;
        const val = (ymax - (k*(ymax-ymin)/4)).toFixed(0);
        ctx.strokeStyle = "rgba(255,255,255,0.07)";
        ctx.beginPath(); ctx.moveTo(x0, yy); ctx.lineTo(x1, yy); ctx.stroke();
        ctx.fillText(val, 6, yy+4);
      }

      // plot helper
      function plot(series, color) {
        if (!series || !series.length) return;
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;
        ctx.beginPath();
        for (let i=0;i<series.length;i++){
          const xi = x(i), yi = y(series[i]);
          if (i===0) ctx.moveTo(xi, yi); else ctx.lineTo(xi, yi);
        }
        ctx.stroke();
      }

      // colors (match legend swatches)
      const strategyColor = "#8ab4f8";
      const benchColor = "#fbbc04";

      plot(curve.bench, benchColor);
      plot(curve.strat, strategyColor);
    }

    window.addEventListener("resize", sizeCanvas);

    function updateChartFromBacktest(bt) {
      // Prefer server-provided equity_curve
      if (bt && bt.equity_curve && Array.isArray(bt.equity_curve.equity)) {
        curve = {
          dates: bt.equity_curve.dates || [],
          strat: bt.equity_curve.equity || [],
          bench: bt.equity_curve.benchmark || []
        };
        chartNote.textContent = "Chart from server-provided equity_curve.";
      } else if (bt && bt.equity_curve && Array.isArray(bt.equity_curve.benchmark)) {
        curve = { dates: bt.equity_curve.dates || [], strat: [], bench: bt.equity_curve.benchmark };
        chartNote.textContent = "Only benchmark provided.";
      } else {
        curve = null;
        chartNote.textContent = "No equity_curve in response.";
      }
      sizeCanvas();
    }

    // --- Init ---
    document.addEventListener("DOMContentLoaded", ()=>{
      const end=new Date(), start=new Date(); start.setFullYear(end.getFullYear()-1);
      $("start").value=start.toISOString().slice(0,10); $("end").value=end.toISOString().slice(0,10);

      const saved = sessionStorage.getItem("qcCollapsed");
      if (saved === null) {
        const isMobile = window.innerWidth <= 1000;
        setQCCollapsed(!isMobile);
      } else {
        setQCCollapsed(saved === "1");
      }
      checkHealth(false);
      setTimeout(()=>{ if(sessionStorage.getItem("qcCollapsed")==="0"){ qcBody.style.height = qcBody.scrollHeight + "px"; }}, 120);

      // kick chart sizing once
      sizeCanvas();
    });

    new ResizeObserver(()=>{ if(sessionStorage.getItem("qcCollapsed")==="0"){ qcBody.style.height = qcBody.scrollHeight + "px"; } }).observe(qcBody);

    // --- Quick Check actions ---
    const statusEl=$("status"), outEl=$("out");
    const setStatus=(m,c="")=>{statusEl.className="status "+c;statusEl.innerHTML=m};
    const loading=()=>setStatus('<span class="spinner"></span> Loading…');
    const ok= m=>setStatus(m,"ok"); const err=m=>setStatus(m,"err");

    $("btnPing").addEventListener("click", async ()=>{
      try{
        loading(); outEl.textContent="(waiting for response …)";
        const res = await fetch("/"); if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json(); outEl.textContent = JSON.stringify(data,null,2); ok("Success");
      }catch(e){ err(String(e.message||e)); outEl.textContent="No response or an error occurred."; }
    });
    $("btnClearPing").addEventListener("click", ()=>{ outEl.textContent="(click the button)"; setStatus(""); });

    // --- Hedge-Fund Controls ---
    $("btnRun").addEventListener("click", async ()=>{
      try{
        hfLoading(); hfOut.textContent="(running …)";
        const payload={tickers:getTickers(),start_date:$("start").value||null,end_date:$("end").value||null,initial_cash:Number($("cash").value||100000)};
        const data=await postJSON("/hedge-fund/run",payload);
        hfOut.textContent = JSON.stringify(data,null,2); hfOk("Run complete");
        // Run doesn't produce equity_curve; leave chart as-is.
      }catch(e){ hfErr(String(e.message||e)); hfOut.textContent="Error."; }
    });

    $("btnBacktest").addEventListener("click", async ()=>{
      try{
        hfLoading(); hfOut.textContent="(backtesting …)";
        const payload={tickers:getTickers(),start_date:$("start").value,end_date:$("end").value,initial_capital:Number($("cash").value||100000)};
        if(!payload.start_date || !payload.end_date) throw new Error("Pick start and end dates.");
        const data=await postJSON("/hedge-fund/backtest",payload);
        hfOut.textContent = JSON.stringify(data,null,2); hfOk("Backtest complete");
        updateChartFromBacktest(data);
      }catch(e){ hfErr(String(e.message||e)); hfOut.textContent="Error."; updateChartFromBacktest(null); }
    });

    // CSV / PNG
    $("btnCSV").addEventListener("click", ()=>{
      const blob=new Blob([hfOut.textContent||""],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="results.csv"; a.click(); URL.revokeObjectURL(a.href);
    });
    $("btnPNG").addEventListener("click", ()=>{
      const canvas2=document.createElement("canvas"), pre=hfOut, w=1000,h=600;
      canvas2.width=w; canvas2.height=h; const c2=canvas2.getContext("2d");
      c2.fillStyle="#0b0f17"; c2.fillRect(0,0,w,h);
      c2.fillStyle="#e7e9ee"; c2.font="14px ui-monospace, Consolas, monospace";
      const lines=(pre.textContent||"").split("\n"); let y=24; for(const line of lines.slice(0,34)){c2.fillText(line.slice(0,150),16,y); y+=18;}
      const a=document.createElement("a"); a.href=canvas2.toDataURL("image/png"); a.download="results.png"; a.click();
    });
    $("btnClear").addEventListener("click", ()=>{ hfOut.textContent="(results will appear here)"; setHF(""); updateChartFromBacktest(null); });
  </script>
</body>
</html>

