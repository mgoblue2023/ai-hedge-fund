<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AI Hedge Fund</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --ok:#10b981; --down:#ef4444; --muted:#6b7280; --border:#e5e7eb; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #fafafa; color: #111827; }
    header { position: sticky; top: 0; background: white; border-bottom: 1px solid var(--border); padding: 12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .title { font-weight: 700; }
    .row { display:flex; gap:8px; align-items:center; }
    .pill { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; border: 1px solid var(--border); }
    .pill.ok { color: #065f46; background: #ecfdf5; border-color: #a7f3d0; }
    .pill.down { color: #7f1d1d; background: #fef2f2; border-color: #fecaca; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 16px 40px; }
    section.card { background:white; border:1px solid var(--border); border-radius: 14px; padding: 16px; margin: 16px 0; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    h2 { margin: 0 0 12px; }
    label { font-size: 12px; color: var(--muted); display: flex; flex-direction: column; gap:6px; }
    input, select { padding: 8px 10px; border:1px solid var(--border); border-radius: 10px; font-size: 14px; width: 100%; }
    button { padding: 10px 14px; border:1px solid var(--border); background:white; border-radius: 12px; font-weight:600; cursor:pointer; }
    button:hover { background:#f9fafb; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .grid { display:grid; grid-template-columns:repeat(6,minmax(140px,1fr)); gap: 12px; }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2,minmax(140px,1fr)); } }
  </style>
</head>
<body>
  <header>
    <div class="title">AI Hedge Fund — Web</div>
    <div class="row">
      <button id="btn-health" onclick="checkHealth()">Health</button>
      <span id="pill" class="pill">Checking…</span>
    </div>
  </header>

  <main>
    <!-- Trade Sizing -->
    <section class="card">
      <h2>Trade Sizing</h2>
      <div class="grid">
        <label>Mode
          <select id="ts-mode">
            <option value="risk_pct">Risk %</option>
            <option value="allocation_pct">Allocation %</option>
            <option value="fixed_cash">Fixed Cash</option>
          </select>
        </label>
        <label>Price <input id="ts-price" type="number" step="0.0001" placeholder="e.g. 100"></label>
        <label>Equity <input id="ts-equity" type="number" step="0.01" placeholder="e.g. 25000"></label>
        <label>Risk % <input id="ts-risk" type="number" step="0.01" placeholder="e.g. 1"></label>
        <label>Stop Price <input id="ts-stop" type="number" step="0.0001" placeholder="e.g. 95"></label>
        <label>Allocation % <input id="ts-alloc" type="number" step="0.01" placeholder="e.g. 5"></label>
        <label>Fixed Cash <input id="ts-cash" type="number" step="0.01" placeholder="e.g. 5000"></label>
        <label>Lot Size <input id="ts-lot" type="number" step="1" value="1"></label>
        <label>Min Qty <input id="ts-min" type="number" step="1" value="1"></label>
        <label>Max Qty <input id="ts-max" type="number" step="1" placeholder=""></label>
        <label>Symbol <input id="ts-symbol" placeholder="e.g. AAPL"></label>
        <label>Side
          <select id="ts-side"><option>BUY</option><option>SELL</option></select>
        </label>
        <label style="grid-column:1/-1;">Strategy <input id="ts-strategy" placeholder="optional tag"></label>
      </div>
      <div style="margin-top:12px;">
        <button onclick="calculateSize()">Calculate Size</button>
        <span id="ts-out" style="margin-left:12px;font-weight:600;"></span>
      </div>
    </section>

    <!-- Execute + Log -->
    <section class="card">
      <h2>Execution</h2>
      <div class="grid">
        <label>Symbol <input id="ex-symbol" placeholder="e.g. AAPL"></label>
        <label>Side
          <select id="ex-side"><option>BUY</option><option>SELL</option></select>
        </label>
        <label>Qty <input id="ex-qty" type="number" step="1"></label>
        <label>Price <input id="ex-price" type="number" step="0.0001"></label>
        <label>Slippage (bps) <input id="ex-slip" type="number" step="0.1" value="0"></label>
        <label>Fee <input id="ex-fee" type="number" step="0.01" value="0"></label>
        <label style="grid-column:1/-1;">Strategy <input id="ex-strategy" placeholder="optional"></label>
        <label style="grid-column:1/-1;">Notes <input id="ex-notes" placeholder="optional"></label>
      </div>
      <div style="margin-top:12px;">
        <button onclick="executeTrade()">Execute (simulate)</button>
        <span id="ex-out" style="margin-left:12px;font-weight:600;"></span>
      </div>

      <h3 style="margin:20px 0 8px;">Execution Log</h3>
      <div style="margin-bottom:8px;">
        <input id="fltr-symbol" placeholder="filter symbol" style="margin-right:6px;">
        <input id="fltr-strategy" placeholder="filter strategy" style="margin-right:6px;">
        <button onclick="loadExecs()">Refresh</button>
      </div>
      <div style="overflow:auto;max-height:420px;border:1px solid #eee;border-radius:8px;background:white;">
        <table id="exec-table">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Sym</th><th>Side</th><th>Qty</th><th>Price</th><th>Fill</th>
              <th>Slip (bps)</th><th>Fee</th><th>Status</th><th>Strategy</th><th>Notes</th><th>ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const BASE = window.location.origin;

    function val(id){ return document.getElementById(id).value; }
    function num(id){ const v = document.getElementById(id).value; return v === "" ? null : Number(v); }

    async function checkHealth(){
      const pill = document.getElementById("pill");
      try{
        const r = await fetch(`${BASE}/health`, {cache:"no-store"});
        const data = await r.json();
        const ok = (data.status || "").toUpperCase() === "OK";
        pill.textContent = ok ? "OK" : "Down";
        pill.className = "pill " + (ok ? "ok" : "down");
      }catch(e){
        pill.textContent = "Down";
        pill.className = "pill down";
      }
    }

    async function calculateSize(){
      const body = {
        mode: val("ts-mode"),
        price: Number(val("ts-price")),
        equity: Number(val("ts-equity")),
        risk_pct: num("ts-risk"),
        stop_price: num("ts-stop"),
        allocation_pct: num("ts-alloc"),
        cash_to_use: num("ts-cash"),
        lot_size: Number(val("ts-lot") || 1),
        min_qty: Number(val("ts-min") || 1),
        max_qty: num("ts-max"),
        symbol: val("ts-symbol") || null,
        side: val("ts-side") || null,
        strategy: val("ts-strategy") || null
      };
      const r = await fetch(`${BASE}/hedge-fund/size`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text();
        document.getElementById("ts-out").textContent = `Error: ${txt}`;
        return;
      }
      const data = await r.json();
      document.getElementById("ts-out").textContent =
        `Qty ${data.qty} (~$${Number(data.dollars).toFixed(2)}), mode=${data.mode_used}`;

      if (data.qty > 0){
        document.getElementById("ex-symbol").value = body.symbol || "";
        document.getElementById("ex-side").value = body.side || "BUY";
        document.getElementById("ex-qty").value = data.qty;
        document.getElementById("ex-price").value = body.price;
        document.getElementById("ex-strategy").value = body.strategy || "";
      }
    }

    async function executeTrade(){
      const body = {
        symbol: val("ex-symbol"),
        side: val("ex-side"),
        qty: Number(val("ex-qty")),
        price: Number(val("ex-price")),
        slippage_bps: Number(val("ex-slip") || 0),
        fee: Number(val("ex-fee") || 0),
        strategy: val("ex-strategy") || null,
        notes: val("ex-notes") || null
      };
      const r = await fetch(`${BASE}/hedge-fund/execute`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text();
        document.getElementById("ex-out").textContent = `Error: ${txt}`;
        return;
      }
      const data = await r.json();
      document.getElementById("ex-out").textContent =
        `OK #${data.id} @ ${data.fill_price} (net fee ${body.fee})`;
      loadExecs();
    }

    async function loadExecs(){
      const p = new URLSearchParams();
      const sym = val("fltr-symbol").trim();
      const strat = val("fltr-strategy").trim();
      if (sym) p.set("symbol", sym);
      if (strat) p.set("strategy", strat);
      const r = await fetch(`${BASE}/hedge-fund/executions?${p.toString()}`);
      const rows = await r.json();
      const tb = document.querySelector("#exec-table tbody");
      tb.innerHTML = "";
      for (const x of rows){
        const tr = document.createElement("tr");
        const cells = [
          x.ts_utc, x.symbol, x.side, x.qty, x.price, x.fill_price,
          x.slippage_bps, x.fee, x.status, x.strategy || "", x.notes || "", x.id
        ];
        for (const c of cells){
          const td = document.createElement("td");
          td.textContent = c;
          tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const mode = document.getElementById("ts-mode");
      const toggleFields = () => {
        const m = mode.value;
        document.getElementById("ts-risk").parentElement.style.display = (m==="risk_pct") ? "" : "none";
        document.getElementById("ts-stop").parentElement.style.display = (m==="risk_pct") ? "" : "none";
        document.getElementById("ts-alloc").parentElement.style.display = (m==="allocation_pct") ? "" : "none";
        document.getElementById("ts-cash").parentElement.style.display = (m==="fixed_cash") ? "" : "none";
      };
      mode.addEventListener("change", toggleFields);
      toggleFields();

      checkHealth();
      setInterval(checkHealth, 30000);
      loadExecs();
    });
  </script>
</body>
</html>
